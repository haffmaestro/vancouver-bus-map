<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .bus {
    fill: #434344;
    stroke-linejoin: round;
  }
</style>
<svg></svg>
<script src="d3.js"></script>
<script src="d3-tile.js"></script>
<script>
  var pi = Math.PI,
  tau = 2 * pi;

  var svg = d3.select("svg"),
      width = window.innerWidth - 20,
      height = window.innerHeight - 20;

  svg.attr("width", width);
  svg.attr("height", height);

  // Choose the projection of the map to use, mercator is fine for this kind of small localized map
  var projection = d3.geoMercator()
    .scale((1 << 20) / tau)
    .translate([width / 2, height / 2])
    .center([-123.17, 49.26]);

  var path = d3.geoPath()
    .projection(projection);

  var tiles = d3.tile()
    .size([width, height])
    .scale(projection.scale() * tau)
    .translate(projection([0, 0]))();

  svg.selectAll("image")
    .data(tiles)
    .enter().append("image")
    .attr("xlink:href", getOSMTileUrl)
    .attr("x", getXCoordinate)
    .attr("y", getYCoordinate)
    .attr("width", tiles.scale)
    .attr("height", tiles.scale);

  attachBuses();
  setInterval(attachBuses, 10000);

  function type(d) {
    const coordinates = [+d.Longitude, +d.Latitude];
    // This is GeoJSON notation 
    const instructions = {
      type: "Feature",
      geometry: {type: "Point", coordinates}
    }
    return instructions;
  }

  function getOSMTileUrl(d) {
    return "http://" + "abc"[d[1] % 3] + ".tile.openstreetmap.org/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; 
  }

  function getXCoordinate(d) {
    return (d[0] + tiles.translate[0]) * tiles.scale;
  }

  function getYCoordinate(d) {
    return (d[1] + tiles.translate[1]) * tiles.scale;
  }

  function attachBuses() {
    d3.json("https://api.18257440082045.stackery-stacks.io/buses", (error, buses) => {

      var busPaths = svg.selectAll(".bus");
      
      // datum / data
      // datum is when you want to set the d3 data for an html object but the number of html objects
      // dont necessarily join 1 <> 1 with the data
      // data is when you want to have a 1 <> 1 relationship between the data and each html object
      // vectorLayer
      //   .datum({type: "FeatureCollection", features: buses.map(type)})
      //   .attr('d', path); // 'd' attribute is the attribute describes the svg element in SVG Path Mini Language

      busPaths
        .data(buses.map(type), (d) => d) 
        .enter()
          .append('path').attr('class', 'bus')
        .attr('d', path);

      busPaths
        .data(buses.map(type), (d) => d)
        .exit()
          .remove();
    })
  }

</script>
